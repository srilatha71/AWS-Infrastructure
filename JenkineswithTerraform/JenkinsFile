pipeline {
    agent any

    environment {
        AWS_REGION = "us-east-1"
        AWS_CREDS = credentials('aws-creds')   // AWS IAM Access + Secret key
        KEY_PATH = "/var/lib/jenkins/workspace/terraform-pipeline/JenkineswithTerraform/Terraform/my-ec2-key"
    }

    stages {
      stage('Install AWS CLI') {
            steps {
                sh '''
                    set -e

                    if command -v aws >/dev/null 2>&1; then
                        echo "AWS CLI already installed."
                        aws --version
                    else
                        sudo apt-get update -y
                        sudo apt-get install -y unzip

                        curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                        unzip -o awscliv2.zip
                        sudo ./aws/install
                        aws --version
                    fi
                '''
            }
        }
  stage('Configure AWS Credentials') {
    environment {
        AWS_CREDS = credentials('aws-creds')
    }
    steps {
        sh '''
            echo "Configuring AWS CLI credentials..."

            mkdir -p ~/.aws

            cat > ~/.aws/credentials <<EOF
[default]
aws_access_key_id=${AWS_CREDS_USR}
aws_secret_access_key=${AWS_CREDS_PSW}
EOF

            cat > ~/.aws/config <<EOF
[default]
region=us-east-1
output=json
EOF

            echo "AWS CLI configured successfully."
        '''
    }
}

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/srilatha71/AWS-Infrastructure.git'
            }
        }

        stage('Terraform Init') {
            steps {
                sh """
                 cd /var/lib/jenkins/workspace/terraform-pipeline/JenkineswithTerraform/Terraform
                 /usr/bin/terraform init
                 """
            }
        }

        stage('Terraform Apply') {
            steps {
                sh """
                  cd /var/lib/jenkins/workspace/terraform-pipeline/JenkineswithTerraform/Terraform
                 /usr/bin/terraform apply --auto-approve -var key_name=my-ec2-key
                """
            }
        }

        stage('Get EC2 Public IP') {
    steps {
        script {

            // Go to Terraform directory and read output
            env.SERVER_IP = sh(
                script: """
                    cd /var/lib/jenkins/workspace/terraform-pipeline/JenkineswithTerraform/Terraform
                    terraform output -raw instance_ip
                """,
                returnStdout: true
            ).trim()

            echo "EC2 Public IP = ${SERVER_IP}"
        }
    }
}


        stage('Copy Application Folder') {
            steps {
                sh """
                chmod 600 ${KEY_PATH}
                ls -ltr
                cd /var/lib/jenkins/workspace/terraform-pipeline/JenkineswithTerraform/
                scp -o StrictHostKeyChecking=no -i ${KEY_PATH} -r /var/lib/jenkins/workspace/terraform-pipeline/JenkineswithTerraform/files/sample-app.jar ubuntu@${SERVER_IP}:/home/ubuntu/
                """
            }
        }

        stage('Deploy App') {
            steps {
                sh """
                ssh -o StrictHostKeyChecking=no -i ${KEY_PATH} ubuntu@${SERVER_IP} 'bash -s' < /var/lib/jenkins/workspace/terraform-pipeline/JenkineswithTerraform/script/deploy.sh
                """
            }
        }
    }
}
